{# {% if mostrarPuntoventaPopup(app.session.get('local') == true ) %}
{% set plantilla = 'basePv' %}
{% else %}
{% set plantilla = 'base' %}
{% endif %} #}

{% set plantilla = 'basePv' %}
    
{% extends plantilla ~ '.html.twig' %}

{% block stylesheets %}
    {{ parent() }}
    <link rel="stylesheet" type="text/css" href="https://printjs-4de6.kxcdn.com/print.min.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.6-rc.0/css/select2.min.css" rel="stylesheet" />

    


    <style>
        #resultado, #existente {
            background-color: red;
            color: white;
            font-weight: bold+            
            margin-top: 20px;
        }
        #resultado.ok, #existente.ok {
            background-color: green;
        }

        .no-border {
            border: 0;
            box-shadow: none;
        }

        div.dataTables_filter{
            text-align: left !important;
        }

        .punto-venta{
            min-width: 960px;
        }

        .producto .caracteristicas{
            background-color: #000000;
            color: #FFFFFF;
            text-align: center;
            font-size: 0.75rem;

        }

        .producto a{
            color: #FFFFFF;
        }        
  

        .producto .caracteristicas .nombre{
            min-height: 45px;
        }

        .fila-producto{
            margin-bottom: 10px;
        }

        .borde{
            border-left: 1px solid #CCCCCC;
        }

        .venta-cuenta .cabecera{
            font-weight: bold;
        }

        .venta-total{
            font-size: 3rem;
            font-weight: bold;
        }

        .venta-impuestos{
            font-size: 2rem;
            font-weight: bold;
        }        

        .linea-separadora{
            margin-top: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .categorias{
            margin-left: 0px;
        }

        .scrollable {
          height:350px;
          overflow-y: scroll;
        }

        .producto img{
            border: 1px solid #000000;
        }

        .categorias img{
            border: 1px solid #ea9f43;
        }

        .productos-slider{
            overflow: auto;
            overflow-x: hidden;
            height: 400px;
            padding-right: 10px;
        }

        /* width */
        .productos-slider::-webkit-scrollbar {
            width: 40px;
        }
        /* Track */
        .productos-slider::-webkit-scrollbar-track {
            background: #f1f1f1; 
        }
         
        /* Handle */
        .productos-slider::-webkit-scrollbar-thumb {
            background: #888; 
        }

        /* Handle on hover */
        .productos-slider::-webkit-scrollbar-thumb:hover {
            background: #555; 
        }        
    
        .puntoVenta{
            width:960px;
            /*margin-left:-200px;*/
        }  

        .producto{
            width: 100px;
        }  

        #guiaHtml { 

            height:297mm; 
            width:210mm; 
            margin-left:auto; 
            margin-right:auto; 
        }

    </style>

    <link rel="stylesheet" type="text/css" href="{{asset('js/slick/slick.css')}}"/>        
    <link rel="stylesheet" type="text/css" href="{{asset('js/slick/slick-theme.css')}}"/>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/paper-css/0.3.0/paper.css">

{% endblock %}

{% block body %}


    {% for label, messages in app.flashes %}
        {% for message in messages %}
            <div class="alert alert-{{ label }}" role="alert">
                {{ message }}
                <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>                
            </div>
        {% endfor %}
    {% endfor %}

    {% set tipo_de_cambio_compra = '' %}
    {% set tipo_de_cambio_venta = '' %}
    {% set alerta = 'warning' %}
    {% if tipoCambio %}
        {% set tipo_de_cambio_compra = tipoCambio.compra %}
        {% set tipo_de_cambio_venta = tipoCambio.venta %}
        {% set alerta = 'info' %}
    {% endif %}

    <div class="alert alert-{{ alerta }}" role="alert">
        Dólar : {{ tipo_de_cambio_compra != '' and tipo_de_cambio_venta != ''  ? 'Compra = S/. ' ~ tipo_de_cambio_compra ~ ';' ~ ' Venta = S/. ' ~ tipo_de_cambio_venta  : 'Definir el valor del dólar para el día de HOY. Ir a Contabilidad >> Tipo de cambio'}}
        <button type="button" class="close" data-dismiss="alert" aria-label="Close">
            <span aria-hidden="true">&times;</span>
        </button>   
    </div>

    <div id="alerta_android" class="alert alert-success d-none" role="alert">
      El comprobante fue generado exitosamente . Puede verlo desde la Lista de Ventas.

        <button type="button" class="close" data-dismiss="alert" aria-label="Close">
            <span aria-hidden="true">&times;</span>
        </button>        
    </div>

    <div class="row d-none" id="btn_regresar_android">
        <div class="col-12 col-md-12 text-right"><a href="{{ path('detalleventa_lista') }}" class="btn btn-success " >Ir a Lista de Ventas</a></div>
    </div>

    <form id="form"  action="{{ path('detalleventa_new') }}" class="form-horizontal needs-validation" role="form" method="post"  enctype="multipart/form-data"  novalidate>

        <div class="punto-venta"  >

            <hr class="">

            <div class="row">
                <div class="col-12 col-sm-12 col-lg-12 col-xs-12 ">

                    <div class="form-row">
                        <div class="form-group col-sm-2 col-lg-2 col-xs-12">

                            {{ form_row(formCliente.forma_pago,{'value':'1'}) }}
                            <div class="invalid-feedback">
                                Este valor es requerido.
                            </div>                                

                        </div>

                        <div class="form-group col-sm-1 col-lg-1 col-xs-12 ">

                            {{ form_row(formCliente.monto_acuenta) }}

                        </div>

                        <div class="form-group col-sm-1 col-lg-1 col-xs-12 ">

                            {{ form_row(formCliente.numero_dias) }}

                        </div> 

                        <div class="form-group col-sm-5 col-lg-5 col-xs-12">

                            {{ form_label(formCliente.cliente_select) }}
                            <div class="input-group">
                                {{ form_widget(formCliente.cliente_select) }}
                              
                                <div class="input-group-append">
                                    <span class="input-group-text" id="agregar_cliente" ><i class="fa fa-plus fa-lg" data-toggle="tooltip" title="Agregar cliente"></i></span>
                                    <span class="input-group-text" id="editar_cliente"><i class="fa fa-edit fa-lg" data-toggle="tooltip" title="Editar cliente"></i></span>
                                </div>
                                <div class="invalid-feedback">
                                    Este valor es requerido.
                                </div>                                   
                            </div>
 
                        </div>   

                        <div class="form-group col-sm-2 col-lg-2 col-xs-12 ">

                            {{ form_row(formCliente.documento) }}
                            <div class="invalid-feedback">
                                Este valor es requerido.
                            </div>    
                        </div>

                        <div class="form-group col-sm-1 col-lg-1 col-xs-12 d-none">
                            {{ form_row(formCliente.numero_voucher) }}
                        </div> 


                        {{ form_widget(formCliente.estado) }}

                    </div>

                    <div class="form-row">

                        <div class="form-group col-sm-2 col-lg-2 col-xs-12">
                            {{ form_row(formCliente.fecha) }}
                            <div class="invalid-feedback">
                                Este valor es requerido.
                            </div>                                
                        </div> 

                        <div class="form-group col-sm-2 col-lg-2 col-xs-12 d-none">
                            {{ form_row(formCliente.numero_documento) }}                           
                        </div> 


                        <div class="form-group col-sm-2 col-lg-2 col-xs-12">
                            {{ form_label(formCliente.numero_guiaremision) }}
                            {{ form_widget(formCliente.numero_guiaremision) }}
                        </div> 

                        <div class="form-group col-sm-1 col-lg-1 col-xs-12">
                            {{ form_row(formCliente.moneda,{'value':'1'} ) }}
                            <div class="invalid-feedback">
                                Este valor es requerido.
                            </div>                                   
                        </div> 

                        <div class="form-group col-sm-2 col-lg-2 col-xs-12">
                            {{ form_row(formCliente.tipoVenta) }}                           
                        </div> 

                        <div class="form-group col-sm-2 col-lg-2 col-xs-12">
                            {{ form_row(formCliente.ordenCompra) }}                           
                        </div>

                    </div>

                    <div class="form-row">

                        <div class="form-group col-sm-2 col-lg-2 col-xs-12">
                            {{ form_label(formCliente.condicion) }}
                            {{ form_widget(formCliente.condicion) }}
                        </div> 
                        

                        {% set oculto = 'd-none' %}
                        {% if localObj.FacturacionElectronica %}
                            {% set oculto = '' %}
                        {% endif %}

                        <div class="form-group col-sm-2 col-lg-2 col-xs-12  {{ oculto }}">
                            {{ form_label(formCliente.enviarFactura) }}
                            {{ form_widget(formCliente.enviarFactura) }}
                        </div>

                        <div class="form-group col-sm-2 col-lg-2 col-xs-12">
                            {{ form_label(formCliente.detraccion) }}
                            {{ form_widget(formCliente.detraccion) }}
                        </div>


                        <div class="form-group col-sm-2 col-lg-2 col-xs-12 d-none">
                            {{ form_label(formCliente.esGratuita) }}
                            {{ form_widget(formCliente.esGratuita) }}
                        </div>

                    </div>
                    
                    {% set ocultar_empleado = 'd-none' %}


                        <div class="form-row {{ ocultar_empleado }}">
                            
                            <div class="form-group col-sm-4 col-lg-4 col-xs-12 ">
                                {{ form_widget(formCliente.vendedor) }}
                                <div class="invalid-feedback">
                                    Este valor es requerido.
                                </div>                                
                            </div> 

                        </div>

                </div>
            </div>

            <hr class="" style="margin-top: 0px">

            <div class="row">
                <div class="col-6 col-sm-6 col-lg-6 col-xs-12">
                    <div class="row">
                        <div class="col-9 col-sm-9 col-lg-9 col-xs-12">

                            <div class="input-group">
                              <input type="text" class="form-control" placeholder="Buscar productos" name="txtbuscar" id="txtbuscar" aria-describedby="limpiar_buscador" onkeypress="return event.keyCode != 13;" /> 
                              <div class="input-group-append">
                                <span class="input-group-text" id="limpiar_buscador" onclick="$('#txtbuscar').val('');"><i class="fa fa-times fa-lg"></i></span>
                              </div>
                            </div>

                                                   
                        </div>

                        <div class="col-2 col-sm-2 col-lg-2 col-xs-12 ">
                            <button type="button" class="btn btn-primary" id="buscar" >Buscar </button>
                        </div>

                        <div class="col-1 col-sm-1 col-lg-1 col-xs-12 ">
                            <div id="modo_lista">
                              <i class="fa fa-list fa-lg " data-toggle="tooltip" title="Cambiar modo de visualización"></i>
                            </div>                                                       
                        </div>                        


                    </div>

                    <hr class="linea-separadora">

                    <div class="row categorias">
                        {# Categorías #}
                        <div class="col-12 col-sm-12 col-lg-12 col-xs-12">
                            <div class="categorias-slider ">

                                {% for categoria in categorias %}
                                    
                                    <a href="javascript:buscar({{categoria.id}})" class="nav-link text-center">
                                        <span class="small font-weight-bold text-capitalize ">{{ categoria.nombre }}</span>

                                        {% if categoria.imagen %}

                                            <img class="img-fluid" data-lazy="{{ asset('uploads/imagenes/categoria/' ~ categoria.imagen ) }}" src="{{ asset('uploads/imagenes/categoria/' ~ categoria.imagen ) }}"   />

                                        {% else %}

                                            {% set imagen_categoria_default = obtenerImagenCategoriaDefault(app.session.get('local')) %}

                                            <img class="img-fluid" data-lazy="{{ asset('uploads/imagenes/100x100/' ~ imagen_categoria_default ) }}" src="{{ asset('uploads/imagenes/100x100/' ~ imagen_categoria_default ) }}"   />

                                        {% endif %}


                                    </a>

                                {% endfor %}

                            </div>
                        </div>
                    </div>

                    <hr class="linea-separadora">

                    <div class="col-12 col-md-12 productos-slider d-none" id="producto-lista">
                       
                        {% set total = productoXLocals | length %}
                        {% for producto in productoXLocals %}

                                <div class="col-12 col-md-12 imgproductos"  title="{{ 'Stock: ' ~ producto.stock }}"  >
                                  <div class="producto" id="" style="width:auto;">
                                    <a href="#" >

                                        <div class=" caracteristicas " style="background-color: #ffffff;text-align: left;font-size: 1rem;">
                                            <div class="nombre d-inline" style="color:black;">{{ producto.nombre ~ ' [' ~ producto.marca | slice(0, 15) ~ ']'}}  </div>
                                            <div class=" d-inline pull-right" style="color:black;"><span class="precio" >{{ producto.precio | number_format(2,'.','')  }}</span></div>
                                            

                                            {% if producto.precio_x_mayor > 0 %}
                                                <div class="d-inline pull-right mr-2" style="color:black;"> {{ producto.precio_x_mayor | number_format(2,'.','')  }}</div>
                                            {% endif %}
                                                        
                                            <input type="hidden" class="atributos" id="{{ producto.id }}" />
                                            <input type="hidden" class="unidades" id="{{ producto.unidad }}" />
                                            <input type="hidden" class="stock" id="{{ producto.stock }}" />
                                        </div>
                                    </a>
                                  </div>
                                </div>

                        {% endfor %}                        

                    </div>

                    <div class="productos-slider" id="producto-slider">


                            {% set item = 1 %}
                            {% set cierre = 0 %}
                            {% set total = productoXLocals | length %}
                            {% for producto in productoXLocals %}

                                {% if  cierre == 1 or item == 1 %}

                                    {% set cierre = 0 %}
                                    {#<div class="row fila-producto" >#}

                                {% endif %} 

                                {% set imagen_ruta = 'noimage.png' %}
    
                                {% if producto.imagen %}

                                    {% set imagen_ruta = producto.imagen %}

                                {% else %}

                                    {% set imagen_ruta = obtenerImagenProductoDefault(app.session.get('local')) %}                                   

                                {% endif %}                          

                                    <div class="mr-2 mb-2 imgproductos"  title="{{ 'Stock: ' ~ producto.stock }}" style="float:left;height:180px;" >
                                      <div class="producto" id="" >
                                        <a href="#" >

                                            <img imgnombre="{{ producto.nombre }}" imglink="{{ asset('uploads/imagenes/500x500/' ~ imagen_ruta ) }}" class="img-fluid imagen" src="{{ asset('uploads/imagenes/100x100/' ~ imagen_ruta ) }}"  />


                                            <div class=" caracteristicas">
                                                <div class="nombre">{{ producto.nombre ~ ' [' ~ producto.marca | slice(0, 15) ~ ']'}}</div>
                                                <div><em class="simbolo_moneda">S./ </em><span class="precio">{{ producto.precio | number_format(2,'.','')  }}</span></div>

                                                {% if producto.precio_x_mayor > 0 %}
                                                    <div><em class="x_mayor">X Mayor: </em> <em class="simbolo_moneda">S./ </em> {{ producto.precio_x_mayor | number_format(2,'.','')  }}</div>
                                                {% endif %}

                                                <input type="hidden" class="atributos" id="{{ producto.id }}" />
                                                <input type="hidden" class="unidades" id="{{ producto.unidad }}" />
                                                <input type="hidden" class="stock" id="{{ producto.stock }}" />
                                            </div>
                                        </a>
                                      </div>
                                    </div>

                                {% if item is divisible by(4) or  item == total %}

                                    {% set cierre = 1 %}

                                    {#</div>#}

                                {% endif %}                            

                                {% set item = item + 1 %}

                            {% endfor %}

                    </div>


                </div>  


                <div class="col-6 col-sm-6 col-lg-6 col-xs-12 borde venta-cuenta">
                    <div class="row cabecera ml-1">
{#                         <div class="col-1 col-sm-1 col-lg-1">
                            
                        </div> #}
                        <div class="col-3 col-sm-3 col-lg-3 p-0">
                            Producto
                        </div>
                        <div class="col-2 col-sm-2 col-lg-2 p-0">
                            Precio
                        </div>
                        <div class="col-2 col-sm-2 col-lg-2 p-0">
                            Cant.
                        </div>
                        <div class="col-2 col-sm-2 col-lg-2 p-0">
                            IGV
                        </div>                        
                        <div class="col-1 col-sm-1 col-lg-1 p-0">
                            Und.
                        </div>                        
                        <div class="col-2 col-sm-2 col-lg-2 p-0">
                            Subt.
                        </div>
                    </div>

                    <hr class="linea-separadora">

                    <div class="row venta-impuestos">
                        <div class="col-5 col-sm-5 col-md-5 col-xs-12">
                            <span>IGV </span><em id="igv_simbolo_moneda">S./ </em>
                        </div>
                        <div class="col-3 col-sm-3 col-md-3 col-xs-12">
                            <span id="impuestos">0.00</span>
                        </div>                    
                    </div>

                    <hr class="linea-separadora">

                    <div class="row venta-total">
                        <div class="col-5 col-sm-5 col-md-5 col-xs-12">
                            <span>TOTAL </span>  <em id="total_simbolo_moneda">S./ </em>
                        </div>
                        <div class="col-3 col-sm-3 col-md-3 col-xs-12">
                            <span id="total">0.00</span>
                        </div>
                    </div>

                    <div class="row">
                        <button type="submit" id="vender" class="btn btn-primary btn-lg btn-block" >Vender</button>
                    </div>


                    <div class="row mt-4">
                        <div class="col-4 col-md-4 ">
                            <button type="button" id="limpiar" class="btn btn-primary btn-lg " ><i class="fa fa-refresh fa-lg"></i>Limpiar</button>
                        </div>
                    </div>

                </div>

            </div>

        </div>

        <input type="text" id="monto_entregado_pago" value="" name="monto_entregado_pago" class="form-control d-none"/>
        
    </form>


    <div class="modal cliente_factura" tabindex="-1" role="dialog" id="modalClienteFactura">
      <div class="modal-dialog " role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Cliente</h5>
            <button type="button" class="close" onclick="$('#modalClienteFactura').modal('hide');" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">

            <div class="form-row">

                <div class="form-group col-6 col-md-6">
                    {{ form_row(formClientePv.tipoDocumento) }}
                </div>

                <div class="form-group col-6 col-md-6">

                    {{ form_label(formClientePv.ruc) }}               
                    <div class="input-group mb-3">
                        {{ form_widget(formClientePv.ruc) }}
                        <div class="input-group-append">
                            <span class="input-group-text" id="buscar_ruc">
                                <i class="fa fa-search fa-lg " data-toggle="tooltip" title="Buscar por número de RUC"></i>
                            </span>
                        </div>
                          
                    </div>

                </div>

            </div>

            <div class="form-row">

                <div class="form-group col-12 col-md-12">
                    {{ form_label(formClientePv.razonSocial) }}
                    {{ form_widget(formClientePv.razonSocial) }}
                </div>

            </div>

            <div class="form-row">
                <div class="form-group col-12 col-md-12">
                    {{ form_label(formClientePv.direccion) }}
                    {{ form_widget(formClientePv.direccion) }}
                </div>
            </div>

            <div class="form-row">
                <div class="form-group col-12 col-md-12">
                    {{ form_label(formClientePv.email) }}
                    {{ form_widget(formClientePv.email) }}
                </div>
            </div>            
            <input type="hidden" id="distrito" name="distrito" class="form-control">
            <input type="hidden" id="cliente_id" name="cliente_id" class="form-control">

            <div class="form-row">
                <div class="form-group col-12 col-md-12">
                    <div class="d-none" id="mensaje_cliente"></div>
                </div>
            </div>

          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-primary" id="guardar_cliente">Guardar</button>
            <button type="button" class="btn btn-secondary" onclick="$('#modalClienteFactura').modal('hide');">Cerrar</button>
          </div>
        </div>
      </div>
    </div>



    <!-- Modal -->
    <div class="modal fade imagen" id="modalImagen" tabindex="-1" role="dialog" aria-labelledby="" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalImagenTitle">Modal title</h5>
                    <button type="button" class="close" onclick="$('#modalImagen').modal('hide');" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body" >
                    <div class="row justify-content-center">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="$('#modalImagen').modal('hide');">Cerrar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal mensaje para dar vuelto-->
    <div class="modal fade modalVuelto" id="modalVuelto" tabindex="-1" role="dialog" aria-labelledby="" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered " role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalImagenTitle">Cobrar transacción</h5>
                    <button type="button" class="close" onclick="$('#modalVuelto').modal('hide');" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body" >
                    
                    <div class="form-row">

                        <div class="form-group col-12 col-md-12">
                            <label for="total_a_pagar">Total a pagar</label>
                            <input type="text" class="form-control" id="total_a_pagar" name="total_a_pagar" value="" readonly/>
                        </div>

                        <div class="form-group col-12 col-md-12">
                            <label for="monto_entregado">Monto entregado</label>
                            <input type="text" class="form-control solonumeros" id="monto_entregado" name="monto_entregado" value="" />
                        </div>

                        <div class="form-group col-12 col-md-12">
                            <label for="monto_vuelto">Vuelto</label>
                            <input type="text" class="form-control" id="monto_vuelto" name="monto_vuelto" value="" readonly />
                        </div>

                    </div> 

                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="$('#modalVuelto').modal('hide');">Cerrar</button>
                    <button type="button" class="btn btn-primary" id="guardar_vuelto">Imprimir</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para imprimir-->
{#     <div class="modal" id="modalImprimir" tabindex="-1" role="dialog">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Imprimir</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">

            <div class="row">
                

                <div class="col-lg-12 text-center">
                    <button class="btn btn-primary" id="imprimir_comprobante">Imprimir</button>
                </div>

                <div class="col-12 col-md-12 col-sm-12 col-lg-12 mt-4 ">
                    <div id="comprobante" class="d-flex justify-content-center">

                        {% if rutaPdf %}

                            {{ render(controller(
                                'AppBundle:FacturaVenta:mostrarComprobante',
                                { 'id': facturaId }
                            )) }}

                        {% endif %}

                    </div>
                </div> 



            </div>



          </div>
          <div class="modal-footer">            
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div> #}



    <button type="button" onclick="printJS('{{ rutaPdf }}')"  id="imprimir" class="d-none">PDF</button>
    <button type="button"  id="imprimirGuia" class="d-none">HTML</button>

    <div id="guiaHtml" class="d-none">
        {% if guiaHtml == 'si' %}

            {{ render(controller(
                'AppBundle:FacturaVenta:showGuia',
                { 'facturaId': facturaId }
            )) }}

        {% endif %}
    </div>






{% endblock %}

{% block javascripts %}
    {{ parent() }} 
    <script src="https://printjs-4de6.kxcdn.com/print.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.6-rc.0/js/select2.min.js"></script>
    <script src="{{asset('js/es.js')}}" ></script>
    <script src="{{asset('js/jquery.number.min.js')}}" ></script>

    <script type="text/javascript" src="{{asset('js/slick/slick.min.js')}}"></script>

    <script src="https://www.google.com/cloudprint/client/cpgadget.js"></script>
    <script src="{{asset('js/printThis.js')}}" ></script>

    <script type="text/javascript">


        $('.categorias-slider').slick({
            /*lazyLoad: 'ondemand',
            /*verticalSwiping: true,*/
            //vertical: false,
            infinite: true,
            slidesToShow: 5,
            slidesToScroll: 5
        });


    </script>

    

    <script type="text/javascript">

        function eliminar(id) {

            var total       = $('#total').text();
            var subtotal    = $('#subtotal_'+id).html();
            
            $("#row_"+id).remove();
            $("#linea_"+id).remove();

            var total_act = Number(total) - Number(subtotal);
            //var impuestos = total_act*0.18;

            var impuestos = 0;
            $(".subtotal").each( function () {
                var subt = Number($(this).html());
                impuestos += 0.18*(subt/1.18);

            });

            //total_act = total_act.number( true, 2 );
            //impuestos = impuestos.number( true, 2 );

            $('#total').html($.number( total_act, 2, '.', ',' ));
            $('#impuestos').html($.number( impuestos, 2, '.', ',' ));    
        } 

        function agregarDescripcion(id) {

            var proddescripcion = $('#productodescripcion_'+id).val();

            if(proddescripcion == ''){
                bootbox.prompt({
                    title: "Ingrese descripción.",
                    inputType: 'textarea',
                    closeButton: false,
                    //backdrop: false,
                    onEscape:false,
                    buttons: {
                        confirm: {
                            label: 'Guardar',
                        },
                        cancel: {
                            label: 'Cancelar',
                        }
                    },                
                    callback: function (result) {
                        console.log(result);
                        if(result){
                            $('#productodescripcion_'+id).val(result);
                        }                                        
                    }
                });

            }
            else
            {

                bootbox.prompt({
                    title: "Ingrese descripción.",
                    inputType: 'textarea',
                    value: proddescripcion,
                    onEscape:false,                  
                    closeButton: false,
                    buttons: {
                        confirm: {
                            label: 'Guardar',
                        },
                        cancel: {
                            label: 'Cancelar',
                        }
                    },                
                    callback: function (result) {
                        console.log(result);
                        if(result){
                            $('#productodescripcion_'+id).val(result);
                        }                                              
                    }
                });

            }

        } 

        function obtenerCliente() {

            var cliente = $('#appbundle_detalleventa_cliente_cliente_select').val();
            var respuesta = '';

            $.ajax({
                method: "POST",
                async : false ,
                url: "{{ path('obtenercliente')}}",
                data: { id: cliente}
            })
            .done(function( data ) {

                respuesta = data;

            });

            return respuesta;
        }

        function buscar(id) {

            var fecha = $('#appbundle_detalleventa_cliente_fecha').val();
            var moneda = $('#appbundle_detalleventa_cliente_moneda').val();

            var cliente = obtenerCliente();
            var tipo_cliente = cliente.tipo;

            var modo = 'false';
            if ($("#producto-slider").hasClass("d-none")) {
               modo = 'true';
            }

            var cargandoTexto = '<div class="text-center"><i class="fa fa-circle-o-notch fa-spin"></i>Buscando.....</div>';
        
            if(modo == 'false'){
                $('#producto-slider').html(cargandoTexto);
            }else{
                $('#producto-lista').html(cargandoTexto);
            }

            $.ajax({
              method: "POST",
              url: "{{ path('buscar_productos')}}",
              data: { categoria: id,modo:modo,moneda:moneda,fecha:fecha,tipo_cliente:tipo_cliente}
            })
              .done(function( data ) {

                if(data.error){

                    bootbox.alert(data.error);
                    $('#appbundle_detalleventa_cliente_moneda').val(1);
                    $('#buscar').trigger("click");               

                }
                else
                {

                    if(modo == 'false'){
                        $('#producto-slider').html(data);
                    }else{
                        $('#producto-lista').html(data);
                    }

                }

                if(moneda == 2){
                    $('.simbolo_moneda').html('$ ');
                    $('#total_simbolo_moneda').html(' $');
                    $('#igv_simbolo_moneda').html(' $');
                }else
                {
                    $('.simbolo_moneda').html('S./ ');
                    $('#total_simbolo_moneda').html(' S./');
                    $('#igv_simbolo_moneda').html(' S./');                    
                }

                if(tipo_cliente == 'mayorista')
                {
                    $('.x_mayor').html('P.Un.: ');
                }
                else
                {
                    $('.x_mayor').html('X Mayor: ');
                }
                

            });               
        } 

        var item = 1;
        var total = 0;
        var ventaNegativo = '{{ permiteVentaConStockNegativo(local) }}';
        $(document).ready(function(){

            var txtcliente          = $('#appbundle_detalleventa_cliente_cliente_select');
            var txtclientenuevo     = $('#appbundle_detalleventa_cliente_cliente_nuevo');
            var txttipodocumento    = $('#appbundle_detalleventa_cliente_documento');
            var txtformapago        = $('#appbundle_detalleventa_cliente_forma_pago');
            var txtnrovoucher       = $('#appbundle_detalleventa_cliente_numero_voucher');
            var txtmontoacuenta     = $('#appbundle_detalleventa_cliente_monto_acuenta');
            var btnguardarcliente   = $('#guardar_cliente');
            var btnguardarclienteboleta   = $('#guardar_cliente_boleta');
            var btnvender           = $('#vender');
            var btnproforma         = $('#proforma');
            var btnbuscar           = $('#buscar');

            //Valores de cliente nuevo
            var selectipodocumento      = $('#appbundle_cliente_pv_tipoDocumento');
            var txtnombrerazonsocial    = $('#appbundle_cliente_pv_razonSocial');
            var txtdniruc               = $('#appbundle_cliente_pv_ruc');
            var txtdireccion            = $('#appbundle_cliente_pv_direccion');
            var txtemail                = $('#appbundle_cliente_pv_email');
            var txtdistrito             = $('#distrito');
            var txtclienteid            = $('#cliente_id');

            var txtmoneda            = $('#appbundle_detalleventa_cliente_moneda');


            //Valor a buscar 
            var txtbuscar           = $('#txtbuscar');

            //Buscar RUC
            var btn_buscar          = $("#buscar_ruc");

            //Boton limpiar
            var btnlimpiar          = $('#limpiar');

            //Agregar cliente
            var btnagregarcliente   = $('#agregar_cliente');
            //Editar cliente
            var btneditarcliente   = $('#editar_cliente');
            //Guardar vuelto
            var guardar_vuelto     = $('#guardar_vuelto');

            txtbuscar.focus();

            $('body').on('click','#modo_lista',function (event) {
                $('#producto-slider').toggleClass('d-none ');
                $('#producto-lista').toggleClass(' d-none');

                $('#buscar').trigger("click");

            })

            txtmoneda.on('change',function(e) {

                var moneda = $(this).val();
                var fecha = $('#appbundle_detalleventa_cliente_fecha').val();

                var cliente = obtenerCliente();
                var tipo_cliente = cliente.tipo;

                var modo = 'false';
                if ($("#producto-slider").hasClass("d-none")) {
                   modo = 'true';
                }

                var cargandoTexto = '<i class="fa fa-circle-o-notch fa-spin"></i>';

                if(modo == 'false'){
                    $('#producto-slider').html(cargandoTexto);
                }else{
                    $('#producto-lista').html(cargandoTexto);
                }

                var textobuscar = '';
                

                $.ajax({
                  method: "POST",
                  url: "{{ path('buscar_productos')}}",
                  data: { textobuscar: textobuscar,modo: modo,moneda:moneda,fecha:fecha,tipo_cliente:tipo_cliente}
                })
                  .done(function( data ) {

                    if(data.error){

                        bootbox.alert(data.error);
                        $('#appbundle_detalleventa_cliente_moneda').val(1);
                        $('#buscar').trigger("click");               

                    }
                    else
                    {

                        if(modo == 'false'){
                            $('#producto-slider').html(data);
                        }else{
                            $('#producto-lista').html(data);
                        }

                    }

                    if(moneda == 2){
                        $('.simbolo_moneda').html('$ ');
                        $('#total_simbolo_moneda').html(' $');
                        $('#igv_simbolo_moneda').html(' $');
                    }else
                    {
                        $('.simbolo_moneda').html('S./ ');
                        $('#total_simbolo_moneda').html(' S./');
                        $('#igv_simbolo_moneda').html(' S./');                    
                    }               

                    if(tipo_cliente == 'mayorista')
                    {
                        $('.x_mayor').html('P.Un.: ');
                    }
                    else
                    {
                        $('.x_mayor').html('X Mayor: ');
                    }

                });   

            });

            $('body').on('keydown','.solonumeros',function (event) {


                if (event.shiftKey == true) {
                  event.preventDefault();
                }

                if ((event.keyCode >= 48 && event.keyCode <= 57) || 
                  (event.keyCode >= 96 && event.keyCode <= 105) || 
                  event.keyCode == 8 || event.keyCode == 9 || event.keyCode == 37 ||
                  event.keyCode == 39 || event.keyCode == 46 || event.keyCode == 190 || event.keyCode == 110) {

                } else {
                  event.preventDefault();
                }

                if($(this).val().indexOf('.') !== -1 && event.keyCode == 190)
                  event.preventDefault(); 

            });



            function deshabilitarBotones()
            {
                $('#vender').prop('disabled', true);
                $('#proforma').prop('disabled', true);
                $('#buscar').prop('disabled', true);
                $('#limpiar').prop('disabled', true);
            }

            function habilitarBotones()
            {
                $('#vender').prop('disabled', false);
                $('#proforma').prop('disabled', false);
                $('#buscar').prop('disabled', false);
                $('#limpiar').prop('disabled', false);
            }

            function confirmarImpresion()
            {
                var total_pagar     = Number($('#total').html());
                var monto_entregado = $("#monto_entregado").val();
                var monto_vuelto    = $("#monto_vuelto").val();

                $("#total_a_pagar").val(total_pagar);
                $('#modalVuelto').modal('show');

                if(monto_entregado != '')
                {
                    return true;
                }
                else
                {
                    return false; 
                }                    
            }

            guardar_vuelto.on("click",function(e){

                var total_pagar     = Number($('#total').html());
                var monto_entregado = $("#monto_entregado").val();
                var monto_vuelto    = $("#monto_vuelto").val();

                $("#monto_entregado_pago").val(monto_entregado);

                if(monto_entregado == ''){
                    bootbox.alert("Ingresar el monto entregado.");                    
                }
                else
                {
                    $('#modalVuelto').modal('hide');
                    $("form").submit();
                }

            });

            $("#monto_entregado").on("keyup",function(){

                var total_pagar     = Number($('#total').html());
                var monto_entregado = $(this).val();
                var monto_vuelto    = Number($(this).val()) - total_pagar;

                $("#monto_vuelto").val(monto_vuelto);

            })

            $('#modalVuelto').on('hidden.bs.modal', function (e) {
               habilitarBotones();
            })

            selectipodocumento.on("change", function(e) {

                e.preventDefault();

                var valor = this.value;

                if(valor == 1){

                    txtdniruc.prop('maxLength', 8);


                }else if(valor == 2){

                    txtdniruc.prop('maxLength', 11);

                }else{

                    txtdniruc.prop('maxLength', 11);

                }

            });

            btnagregarcliente.on('click',function(e){

                e.preventDefault();

                selectipodocumento.val('');
                txtnombrerazonsocial.val('');
                txtdniruc.val('');
                txtdireccion.val('');
                txtemail.val('');
                //txttelefono.val('');
                //txttipo.val('');                            
                $('#cliente_id').val('');

                selectipodocumento.prop('disabled', false);
                txtnombrerazonsocial.prop('disabled', false);
                txtdniruc.prop('disabled',false);
                txtdireccion.prop('disabled',false);
                txtemail.prop('disabled',false);
                btnguardarcliente.prop('disabled',false);

                $('.cliente_factura').modal('show');

            });

            btneditarcliente.on('click',function(e){

                e.preventDefault();

                var cliente = $('#appbundle_detalleventa_cliente_cliente_select').val();

                if(cliente == ''){

                    bootbox.alert("Debe seleccionar un cliente para que pueda editar.");                    
                    return false;

                }else{

                    var respuesta = obtenerCliente(function(output){});

                    var direccion        = respuesta.direccion;
                    var email            = respuesta.email;
                    var razon_social     = respuesta.razon_social;
                    var numero_documento = respuesta.numero_documento;
                    var tipo_documento   = respuesta.tipo_documento;
                    var distrito         = respuesta.distrito;
                    var cliente_id       = respuesta.id;

                    selectipodocumento.val(tipo_documento);
                    txtnombrerazonsocial.val(razon_social);
                    txtdniruc.val(numero_documento);
                    txtdireccion.val(direccion);
                    txtemail.val(email);
                    txtdistrito.val(distrito);
                    txtclienteid.val(cliente_id);

                    if(numero_documento == '---')
                    {
                        selectipodocumento.prop('disabled', true);
                        txtnombrerazonsocial.prop('disabled', true);
                        txtdniruc.prop('disabled',true);
                        txtdireccion.prop('disabled',true);
                        txtemail.prop('disabled',true);
                        btnguardarcliente.prop('disabled',true);
                    }
                    else
                    {
                        selectipodocumento.prop('disabled', false);
                        txtnombrerazonsocial.prop('disabled', false);
                        txtdniruc.prop('disabled',false);
                        txtdireccion.prop('disabled',false);
                        txtemail.prop('disabled',false);
                        btnguardarcliente.prop('disabled',false);
                    }

                    $('.cliente_factura').modal('show');

                }

            });

            txtformapago.on("change",function(){

                var formapago = this.value;


                if(formapago == 4){

                    txtmontoacuenta.prop('required', false);
                    txtmontoacuenta.prop('readonly', true);
                    txtmontoacuenta.val(0);
                    $( "#monto_acuenta" ).remove();   

                    txtnrovoucher.prop('readonly', false);
                    txtnrovoucher.prop('required', 'required');

                    $( "<div class='invalid-feedback' id='voucher'>Este valor es requerido.</div>" ).insertAfter( "#appbundle_detalleventa_cliente_numero_voucher" );

                }else if(formapago == 5){

                    txtnrovoucher.prop('required', false);
                    txtnrovoucher.prop('readonly', true);
                    $( "#voucher" ).remove();

                    txtmontoacuenta.prop('readonly', false);
                    txtmontoacuenta.prop('required', 'required');

                    $( "<div class='invalid-feedback' id='monto_acuenta'>Este valor es requerido.</div>" ).insertAfter( "#appbundle_detalleventa_cliente_monto_acuenta" );
                }else{

                    txtmontoacuenta.prop('required', false);
                    txtmontoacuenta.prop('readonly', true);
                    txtmontoacuenta.val(0);
                    $( "#monto_acuenta" ).remove();                    
                    txtnrovoucher.prop('required', false);
                    txtnrovoucher.prop('readonly', true);
                    $( "#voucher" ).remove();
                }

            });

            btnguardarcliente.on('click',function (e) {

                e.preventDefault();

                var tipodocumento = selectipodocumento.val();
                var nrazonsocial  = txtnombrerazonsocial.val();
                var dniruc        = txtdniruc.val();
                var direccion     = txtdireccion.val();
                var email         = txtemail.val();
                var distrito      = txtdistrito.val();
                var clienteid     = txtclienteid.val();

                if(tipodocumento == '1'){

                    if( nrazonsocial == '' || dniruc == '' ){

                        bootbox.alert("Se ha seleccionado el tipo DNI. Debe ingresar el nombre y el número de documento.");                    
                        return false;

                    }

                }else if(tipodocumento == '2'){

                    if( nrazonsocial == '' || dniruc == '' || direccion == '' ){

                        bootbox.alert("Se ha seleccionado el tipo RUC. Debe ingresar el nombre , el número de documento y la dirección.");                    
                        return false;

                    }

                }else if(tipodocumento == '3'){

                    if( nrazonsocial == '' || dniruc == '' ){

                        bootbox.alert("Se ha seleccionado el tipo RUC. Debe ingresar el nombre y el número de documento");                    
                        return false;

                    }

                }else if(tipodocumento == '4'){

                    if( nrazonsocial == '' || dniruc == '' ){

                        bootbox.alert("Debe ingresar el nombre y el número de documento.");                    
                        return false;

                    }

                }else if(tipodocumento == '5'){

                    if( nrazonsocial == '' || dniruc == '' ){

                        bootbox.alert("Debe ingresar el nombre y el número de documento.");                    
                        return false;

                    }

                }else if(tipodocumento == '6'){

                    if( nrazonsocial == '' || dniruc == '' ){

                        bootbox.alert("Debe ingresar el nombre y el número de documento.");                    
                        return false;

                    }

                }else if(tipodocumento == '7'){

                    if( nrazonsocial == '' || dniruc == '' ){

                        bootbox.alert("Debe ingresar el nombre y el número de documento.");                    
                        return false;

                    }

                }
                else
                {

                    bootbox.alert("Debe seleccionar el tipo de documento.");                    
                    return false;

                }

                $.ajax({
                  method: "POST",
                  url: "{{ path('registrar_cliente_nuevo')}}",
                  data: { nrazonsocial: nrazonsocial, dniruc: dniruc, direccion: direccion ,distrito: distrito,tipodocumento: tipodocumento,clienteid: clienteid,email:email}
                })
                  .done(function( data ) {

                    console.log(data);

                    if(data.mensaje != ''){
                        $('#mensaje_cliente').removeClass('d-none');
                        $('#mensaje_cliente').addClass('bg-danger text-white');
                        $('#mensaje_cliente').html(data.mensaje);

                    }else{

                        var newOption = new Option(data.text, data.id, false, true);
                        $('#appbundle_detalleventa_cliente_cliente_select').append(newOption).trigger('change');
                        $('.cliente_factura').modal('hide');

                    }


                });   

            });

            txtbuscar.on('keyup',function(e){

                if(e.keyCode == 13){
                    btnbuscar.click();
                }

            });


            btnbuscar.on('click',function () {

                var fecha = $('#appbundle_detalleventa_cliente_fecha').val();
                var moneda = $('#appbundle_detalleventa_cliente_moneda').val();

                var cliente = obtenerCliente();
                var tipo_cliente = cliente.tipo;

                var modo = 'false';
                if ($("#producto-slider").hasClass("d-none")) {
                   modo = 'true';
                }

                var $this = $(this);
                var cargandoTexto = '<i class="fa fa-circle-o-notch fa-spin"></i>';
                if ($(this).html() !== cargandoTexto) {
                  $this.data('original-text', $(this).html());
                  $this.html(cargandoTexto);
                }

                if(modo == 'false'){
                    $('#producto-slider').html(cargandoTexto);
                }else{
                    $('#producto-lista').html(cargandoTexto);
                }
                
                var textobuscar = txtbuscar.val();

                $.ajax({
                  method: "POST",
                  url: "{{ path('buscar_productos')}}",
                  data: { textobuscar: textobuscar,modo: modo,moneda: moneda,fecha: fecha,tipo_cliente:tipo_cliente}
                })
                  .done(function( data ) {

                    setTimeout(function() {
                      $this.html($this.data('original-text'));
                    }, 100);

                    if(data.error){

                        bootbox.alert(data.error);
                        $('#appbundle_detalleventa_cliente_moneda').val(1);
                        $('#buscar').trigger("click");               

                    }
                    else
                    {

                        if(modo == 'false'){
                            $('#producto-slider').html(data);
                        }else{
                            $('#producto-lista').html(data);
                        }

                    }

                    if(moneda == 2){
                        $('.simbolo_moneda').html('$ ');
                        $('#total_simbolo_moneda').html(' $');
                        $('#igv_simbolo_moneda').html(' $');
                    }else
                    {
                        $('.simbolo_moneda').html('S./ ');
                        $('#total_simbolo_moneda').html(' S./');
                        $('#igv_simbolo_moneda').html(' S./');                    
                    }   

                    if(tipo_cliente == 'mayorista')
                    {
                        $('.x_mayor').html('P.Un.: ');
                    }
                    else
                    {
                        $('.x_mayor').html('X Mayor: ');
                    }

                });   

            });

            $('body').on('change','.precioinput',function(){

                var valor   = this.value;
                var id      = this.id;

                var precio      = $('input[name=precio_'+id+']').val();
                var cantidad    = $('input[name=cantidad_'+id+']').val();

                var total_linea = cantidad * precio;

                $('#subtotal_'+id).html(total_linea.toFixed(2));

                var total = 0;
                var impuestos = 0;
                $(".subtotal").each( function () {
                    var subtotal = Number($(this).html());
                    total += Number($(this).html());
                    impuestos += 0.18*(subtotal/1.18);

                });

                $('#total').html($.number( total, 2, '.', ',' ));
                $('#impuestos').html($.number( impuestos, 2, '.', ',' ));                                   

            });

            $('body').on('focusin', '.cantidadinput', function(){

                $(this).data('val', $(this).val());

            }).on('change','.cantidadinput',function(e){

                e.preventDefault();

                var valor   = this.value;
                var id      = this.id;
                

                var precio      = $('input[name=precio_'+id+']').val();
                var cantidad    = $('input[name=cantidad_'+id+']').val();
                var stock       = $('input[name=stock_'+id+']').val();

                var total_linea = cantidad * precio;

                var prev = $(this).data('val');

                if(!ventaNegativo){
                     var dif = stock - cantidad;
                    if( dif < 0){
                        $('input[name=cantidad_'+id+']').val(prev);
                        bootbox.alert("Ya no hay stock suficiente. Stock disponible : "+stock);
                        return false;

                    }

                }

                $('#subtotal_'+id).html(total_linea.toFixed(2));

                var total = 0;
                var impuestos = 0;
                $(".subtotal").each( function () {
                    var subtotal = Number($(this).html());
                    total += Number($(this).html());
                    impuestos += 0.18*(subtotal/1.18);
                });

                $('#total').html($.number( total, 2, '.', ',' ));
                $('#impuestos').html($.number( impuestos, 2, '.', ',' ));     

            });

            var date_diff_indays = function(date1, date2) {
                dt1 = new Date(date1);
                dt2 = new Date(date2);
                return Math.floor((Date.UTC(dt2.getFullYear(), dt2.getMonth(), dt2.getDate()) - Date.UTC(dt1.getFullYear(), dt1.getMonth(), dt1.getDate()) ) /(1000 * 60 * 60 * 24));
            }

            $("form").submit(function(event){

                deshabilitarBotones();              

                var prd = $(".venta-cuenta").find(".row.prod");
                var venta_total_mes = '{{ obtenerVentaTotalMes(local) }}';
                var limite_venta = '{{ limite_venta }}';
                                

                if(prd.length == 0){

                    bootbox.alert("No existen productos agregados!");
                    habilitarBotones();                
                    return false;

                }
                else
                {

                    var fechaValue = $('#appbundle_detalleventa_cliente_fecha').val();
                    fecha = fechaValue.split('/');

                    var today = new Date();
                    var dd = today.getDate();

                    var mm = today.getMonth()+1; 
                    var yyyy = today.getFullYear();
                    if(dd<10) 
                    {
                        dd='0'+dd;
                    } 

                    if(mm<10) 
                    {
                        mm='0'+mm;
                    }

                    var dif = date_diff_indays(fecha[1]+'/'+fecha[0]+'/'+fecha[2],mm+'/'+dd+'/'+yyyy);

                    // if(txttipodocumento.val() == 'factura' || txttipodocumento.val() == 'boleta' ){

                    //     if(dif > 5 || dif < 0 ){

                    //         bootbox.alert("No puede seleccionar una fecha menor a 5 días o mayor a la fecha actual.");
                    //         habilitarBotones();
                    //         return false;

                    //     }

                    // }


                    if(Number(limite_venta) > 0){

                        var dif = Number(venta_total_mes) + Number($('#total').html());

                        if(dif > Number(limite_venta) && txttipodocumento.val() != 'guia' ){
                            bootbox.alert("Se ha superado el límite de venta establecido para este mes, solo se pueden generar guías.");
                            habilitarBotones();               
                            return false;
                        }

                    }

                    var respuesta = obtenerCliente(function(output){});

                    var direccion        = respuesta.direccion;
                    var razon_social     = respuesta.razon_social;
                    var numero_documento = respuesta.numero_documento;
                    var tipo_documento   = respuesta.tipo_documento;

                    var exportacion = 0;
                    $(".tipoimpuesto").each( function () {

                        var val = $(this).val();
                        if(val==16)
                        {
                            exportacion = exportacion + 1;
                        }

                    });

                    if(exportacion > 0 && tipo_documento != 3)
                    {
                        bootbox.alert("No se puede incluir un producto con IGV Exportación si el cliente no es del tipo 'NO DOMICILIADO'.");
                        habilitarBotones();
                        return false;
                    }

                    var tipo_venta = $('#appbundle_detalleventa_cliente_tipoVenta').val();

                    if(exportacion > 0 && tipo_venta == 'venta_interna')
                    {
                        bootbox.alert("No se puede incluir un producto con IGV Exportación para un tipo de Venta Interna.");
                        habilitarBotones();
                        return false;
                    }

                    if(exportacion == 0 && tipo_venta == 'exportacion')
                    {
                        bootbox.alert("No se ha incluido productos con IGV Exportación.");
                        habilitarBotones();
                        return false;
                    }

                    if(prd.length != exportacion && tipo_venta == 'exportacion')
                    {
                        bootbox.alert("Si el tipo de venta es Exportación todos los productos agregados a la lista deberán estar con IGV Exportación .");
                        habilitarBotones();
                        return false;                        

                    }


                    if(txttipodocumento.val() == 'boleta')
                    {
                        if(tipo_venta == 'venta_interna')
                        {

                            if(tipo_documento == 1 && numero_documento.length != 8)
                            {
                                bootbox.alert("Corriga el número de documento del cliente. Debe tener 8 dígitos.");
                                habilitarBotones();
                                return false;
                            }
                            else if(tipo_documento == 2 && numero_documento.length != 11)
                            {
                                bootbox.alert("Corriga el número de documento del cliente. Debe tener 11 dígitos.");
                                habilitarBotones();
                                return false;
                            }
                            else if(numero_documento.length < 8)
                            {

                                var total       = $('#total').text().replace(/,/g , '');   
                                total           = Number(total);

                                if(total > 700){

                                    bootbox.alert("Es obligatorio el ingreso de un cliente con DNI pues el monto supera los 700 Nuevos Soles.");
                                    habilitarBotones();
                                    return false;
                                }

                            }
                            else if(razon_social == '')
                            {

                                bootbox.alert("El nombre no debe estar vacío.");
                                habilitarBotones();
                                return false;  

                            }                            

                            // if(tipo_documento != 1 || numero_documento.length != 8 || razon_social == '' ){

                            //     if(tipo_documento != 1)
                            //     {

                            //         bootbox.alert("Corriga el tipo de documento , se debe seleccionar un cliente con  DNI.");
                            //         habilitarBotones();
                            //         return false;

                            //     }
                            //     else if(numero_documento.length != 8)
                            //     {

                            //         var total       = $('#total').text().replace(/,/g , '');   
                            //         total           = Number(total);

                            //         if(total > 700){

                            //             bootbox.alert("Es obligatorio el ingreso de un cliente con DNI pues el monto supera los 700 Nuevos Soles.");
                            //             habilitarBotones();
                            //             return false;
                            //         }                             

                            //     }
                            //     else if(razon_social == '')
                            //     {

                            //         bootbox.alert("El nombre no debe estar vacío.");
                            //         habilitarBotones();
                            //         return false;  

                            //     }
                                
                            // }

                        }
                        else if(tipo_venta == 'exportacion')
                        {

                            bootbox.alert("No se puede generar una Boleta para el tipo de venta Exportación.");
                            habilitarBotones();
                            return false;

                        }


                    }
                    else if(txttipodocumento.val() == 'factura')
                    {

                        if(tipo_venta == 'venta_interna')
                        {

                            if(tipo_documento != 2 || numero_documento.length != 11 || razon_social == '' || direccion == '' ){

                                if(tipo_documento != 2){

                                    bootbox.alert("Corriga el tipo de documento , se debe seleccionar un cliente con RUC.");
                                    habilitarBotones();
                                    return false;

                                }else if(numero_documento.length != 11){

                                    bootbox.alert("El número de documento debe contener 11 dígitos.");
                                    habilitarBotones();
                                    return false;                                

                                }else if(razon_social == ''){

                                    bootbox.alert("El nombre no debe estar vacío.");
                                    habilitarBotones();
                                    return false;  

                                }else if(direccion == ''){

                                    bootbox.alert("La dirección no debe estar vacía.");
                                    habilitarBotones();
                                    return false;  

                                }


                            }

                        }
                        else if(tipo_venta == 'exportacion')
                        {

                            if(tipo_documento != 3 || numero_documento.length == 0 || razon_social == ''){


                                if(tipo_documento != 3){


                                    bootbox.alert("El cliente debe ser de tipo 'NO DOMICILIADO (Exportacion)'.");
                                    habilitarBotones();
                                    return false;

                                }else if(numero_documento.length == 0){

                                    bootbox.alert("Debe registrar el número de documento.");
                                    habilitarBotones();
                                    return false;                                

                                }else if(razon_social == ''){

                                    bootbox.alert("El nombre no debe estar vacío.");
                                    habilitarBotones();
                                    return false;  

                                }                                

                            }


                        }


                    }
                    else
                    {
                        var total       = $('#total').text().replace(/,/g , '');                   

                        // if(tipo_documento != 1){

                        //     bootbox.alert("Corriga el tipo de documento , se debe seleccionar DNI.");
                        //     habilitarBotones();
                        //     return false;

                        // }else if(numero_documento.length != 8){


                        // }else if(razon_social == ''){

                        //     bootbox.alert("El nombre no debe estar vacío.");
                        //     habilitarBotones();
                        //     return false;  

                        // }

                    }


                    if (this.checkValidity() === false) 
                    {
                      event.preventDefault();
                      event.stopPropagation();
                      habilitarBotones();

                    }else{

                        deshabilitarBotones();

                        var ventana_vuelto = '{{ localObj.ventanaVuelto }}';

                        if(ventana_vuelto)
                        {
                            var confirma_impresion = confirmarImpresion();

                            if(confirma_impresion)
                            {
                                return true;
                            }
                            else
                            {
                                return false;                           
                            }

                        }
                        else
                        {
                            var opcion = confirm("Está seguro de Generar el comprobante.");
                            if (opcion == true) 
                            {
                                return true;

                            } 
                            else 
                            {
                                habilitarBotones();
                                return false;
                            }

                            
                        }
                    }                    
                    
                }

            });


            var timer = 0;
            var delay = 200;
            var prevent = false;
            var tipos_impuesto = '';

            {% for tipoImpuesto in tiposImpuesto %}

                var impuesto_nombre = '{{ tipoImpuesto.nombre }}';
                var impuesto_id = '{{ tipoImpuesto.id }}';

                tipos_impuesto += '<option value="'+impuesto_id+'">'+ impuesto_nombre +'</option>';

            {% endfor %}
 
            $('body')
                .on('click','.producto a',function() {

                    txtbuscar.val('');
                    txtbuscar.focus();

                    var self = this;

                    timer = setTimeout(function() {

                        if (!prevent) {
                            
                            var precio = $('span', self ).text();
                            var nombre = $('.nombre', self ).html();
                            var producto_id = $('.atributos', self ).attr('id');
                            var unidad = $('.unidades', self ).attr('id');
                            var stock  = Number($('.stock', self ).attr('id'));

                            if($('#row_'+producto_id).length == 0 )
                            {
                                var cantidad = 1;
                                var total_linea = Number(cantidad) * Number(precio);        

                                if(!ventaNegativo){
                                     var dif = stock - cantidad;
                                    if( dif < 0){

                                        bootbox.alert("Ya no hay stock suficiente. Stock disponible : "+stock);
                                        return false;

                                    }

                                }

                                $('.venta-impuestos').before('<div class="row prod" id="row_'+producto_id+'"><input type="hidden" class="productoid" id="productoid_'+producto_id+'" name="productoid_'+producto_id+'" value="'+producto_id+'"/><input type="hidden" class="stockid" id="stock_'+producto_id+'" name="stock_'+producto_id+'" value="'+stock+'"/><div class="col-3 col-md-3 p-0" ><a href="javascript:eliminar('+producto_id+')" class="mr-2"><i class="fa fa-remove fa-lg"></i></a>'+ nombre +'<span class="ml-2"><a href="javascript:agregarDescripcion('+producto_id+')" ><i class="fa fa-file-text-o fa-sm"></a></i></span><input type="text" class="d-none" id="productodescripcion_'+producto_id+'" name="productodescripcion_'+producto_id+'" value=""/></div><div class="col-2 col-md-2 p-0"><input type="text" class="form-control precioinput solonumeros" name="precio_'+producto_id+'" id="'+producto_id+'" value="'+Number(precio).toFixed(2)+'"></div><div class="col-2 col-md-2 p-0"><input type="text" class="form-control cantidadinput solonumeros" id="'+producto_id+'" name="cantidad_'+producto_id+'"  value="'+cantidad+'"></div><div class="col-2 col-md-2 p-0"><select class="form-control tipoimpuesto" name="productoimpuesto_'+producto_id+'" >'+ tipos_impuesto +'</select></div><div class="col-1 col-md-1 p-1">'+unidad+'</div><div class="col-2 col-md-2 p-0 subtotal" id="subtotal_'+producto_id+'" >'+ total_linea.toFixed(2) +'</div></div><hr class="linea-separadora" id="linea_'+producto_id+'" >');

                                item = item + 1;

                            }
                            else
                            {
                                var cantidad_nueva  = Number($('input[name=cantidad_'+producto_id+']').val()) + 1;

                                if(!ventaNegativo){
                                     var dif = stock - cantidad_nueva;
                                    if( dif < 0){

                                        bootbox.alert("Ya no hay stock suficiente. Stock disponible : "+stock);
                                        return false;

                                    }

                                }

                                $('input[name=cantidad_'+producto_id+']').val(cantidad_nueva);

                                var precio      = $('input[name=precio_'+producto_id+']').val();
                                var cantidad    = $('input[name=cantidad_'+producto_id+']').val();

                                var total_linea = cantidad * precio;

                                $('#subtotal_'+producto_id).html(total_linea.toFixed(2));

                            }

                            var total = 0;
                            var impuestos = 0;
                            $(".subtotal").each( function () {
                                var subtotal = Number($(this).html());
                                total += Number($(this).html());
                                impuestos += 0.18*(subtotal/1.18);
                            });

                            $('#total').html($.number( total, 2, '.', ',' ));
                            $('#impuestos').html($.number( impuestos, 2, '.', ',' ));     
                        }
                        prevent = false;
                    },delay);
                });

            btn_buscar.on("click", function(){

                var data = {
                  ruc   : txtdniruc.val(),
                  token  : '5JFQh5toA0sWhj-YV3NXmt4dzE4JvJjwgYzzPJtYHgA',
                }

                $.ajax({
                    method: "GET",
                    url: "{{ path('obtenerdatosempresa')}}",
                    data: data,
                    success: function(data){

                        txtnombrerazonsocial.val(data.nombre_o_razon_social);
                        txtdireccion.val(data.direccion_completa);
                        txtdistrito.val(data.distrito_id);
                    }

                });
            });

            btnlimpiar.on('click',function(){

                location.reload();

            })


            var d           = new Date();
            var currDay     = d.getDate();
            var currMonth   = d.getMonth();
            var currYear    = d.getFullYear();
            var startDate   = new Date(currYear, currMonth, currDay);

            $(".setcurrentdate").datepicker({
                format: 'dd/mm/yyyy',
                language: 'es',
                autoclose: true ,
              
            });
            $(".setcurrentdate").datepicker("setDate", startDate);

            // Selecciona el cliente
            $(".select2").select2({
                language: "es",
                ajax: {
                    url: "{{ path('obtenerclientes')}}",
                    dataType: 'json',
                    delay: 100,
                    type: "GET",
                    data: function (params) {
                      return {
                        q: params.term,
                        page: params.page
                      };
                    },
                    processResults: function (data,params) {

                        params.page = params.page || 1;

                        return {
                            results: data.results,
                            pagination: {
                                more: (params.page * 30) < data.total_count
                            }
                        };

                    },
                    cache: true
                },          
                placeholder: 'Buscar cliente por nombres,apellidos,razon social,DNI o RUC',
                minimumInputLength: 3,
            });



            // Fetch the preselected item, and add to the control
            $.ajax({
                type: "GET",
                url: "{{ path('obtener_cliente_default')}}",
            }).then(function (data) {

                if(data.total_count != 0){

                    // create the option and append to Select2
                    var option = new Option(data.results.text, data.results.id, false, true);
                    $('#appbundle_detalleventa_cliente_cliente_select').append(option).trigger('change');

                    // manually trigger the `select2:select` event
                    $('#appbundle_detalleventa_cliente_cliente_select').trigger({
                        type: 'select2:select',
                        params: {
                            data: data
                        }
                    });

                }


            });

            $('.select2').on('select2:select', function (e) {

                var data = e.params.data;

                var tipo_cliente = data.tipo;
                var moneda = $('#appbundle_detalleventa_cliente_moneda').val();
                var fecha  = $('#appbundle_detalleventa_cliente_fecha').val();

                var modo = 'false';
                if ($("#producto-slider").hasClass("d-none")) {
                   modo = 'true';
                }

                var cargandoTexto = '<i class="fa fa-circle-o-notch fa-spin"></i>';

                if(modo == 'false'){
                    $('#producto-slider').html(cargandoTexto);
                }else{
                    $('#producto-lista').html(cargandoTexto);
                }

                var textobuscar = '';                

                $.ajax({
                  method: "POST",
                  url: "{{ path('buscar_productos')}}",
                  data: { textobuscar: textobuscar,modo: modo,moneda:moneda,fecha:fecha,tipo_cliente:tipo_cliente}
                })
                  .done(function( data ) {

                    if(data.error){

                        bootbox.alert(data.error);
                        $('#appbundle_detalleventa_cliente_moneda').val(1);
                        $('#buscar').trigger("click");               

                    }
                    else
                    {

                        if(modo == 'false'){
                            $('#producto-slider').html(data);
                        }else{
                            $('#producto-lista').html(data);
                        }

                    }

                    if(moneda == 2){
                        $('.simbolo_moneda').html('$ ');
                        $('#total_simbolo_moneda').html(' $');
                        $('#igv_simbolo_moneda').html(' $');
                    }else
                    {
                        $('.simbolo_moneda').html('S./ ');
                        $('#total_simbolo_moneda').html(' S./');
                        $('#igv_simbolo_moneda').html(' S./');                    
                    }             

                    if(tipo_cliente == 'mayorista')
                    {
                        $('.x_mayor').html('P.Un.: ');
                    }
                    else
                    {
                        $('.x_mayor').html('X Mayor: ');
                    }
                
                });  
                
            });


            var pdfImprimir = '{{ rutaPdf }}';
            var guiaHtml = '{{ guiaHtml }}';

            //Verifica si el navegador es android
            var ua = navigator.userAgent.toLowerCase();
            var isAndroid = ua.indexOf("android") > -1; //&& ua.indexOf("mobile");

            if(isAndroid)
            {
                //$('#btn_regresar_android').removeClass('d-none');
            }           

            if(pdfImprimir)
            {
                if (isAndroid) {
                  // https://developers.google.com/cloud-print/docs/gadget

                  var gadget = new cloudprint.Gadget();
                  gadget.setPrintDocument("application/pdf", "PDF Doc" );
                  gadget.setPrintDocument("url", 'Comprobante', "{{ app.request.getSchemeAndHttpHost() ~ '/' ~  rutaPdf }}", "utf-8");
                  gadget.openPrintDialog();

                  $('#alerta_android').removeClass('d-none');
                }
                else 
                {
                    $('#imprimir').trigger('click');
                } 


            }

            if(pdfImprimir)
            {
                //$('#imprimirGuia').trigger('click');
                //var div = document.querySelector("#guiaHtml");
                //imprimirElemento(div);

                if(isAndroid)
                {
                    //$('.punto-venta').addClass('d-none');
                }  

                
                //$('#modalImprimir').modal('show');

            }


            function imprimirElemento(elemento) {
              var ventana = window.open('', 'PRINT', 'height=800,width=800');
              ventana.document.write('<html><head><title>' + document.title + '</title>');
              ventana.document.write('<link rel="stylesheet" href="style.css">');
              ventana.document.write('</head><body >');
              ventana.document.write(elemento.innerHTML);
              ventana.document.write('</body></html>');
              ventana.document.close();
              ventana.focus();
              ventana.onload = function () {

                ventana.print();
                ventana.close();
              }
              return true;
            }


            $('#imprimir_comprobante').on('click',function(){

                //$('#comprobante_contenido').printThis();
           
            })            


        });
    </script>


{% endblock %}
